IPCS = [
  'ipc-1998',
  'ipc-2000',
  'ipc-2002',
  'ipc-2004',
  'ipc-2006',
  'ipc-2008',
  'ipc-2011',
  'ipc-2014',
  'ipc-2018',
]

IPC_DOMAINS = {
  "ipc-1998-grid-2",
  "ipc-1998-gripper-1",
  "ipc-1998-logistics-1",
  "ipc-1998-logistics-2",
  "ipc-1998-movie-1",
  "ipc-1998-mystery-1",
  "ipc-1998-mystery-prime-1",
  "ipc-1998-mystery-prime-2",
  "ipc-2000-blocks",
  "ipc-2000-elevator-simple",
  "ipc-2000-freecell",
  "ipc-2000-logistics",
  "ipc-2002-depots",
  "ipc-2002-driverlog",
  "ipc-2002-freecell",
  "ipc-2002-rovers",
  "ipc-2002-satellite",
  "ipc-2002-zenotravel",
  "ipc-2004-airport",
  "ipc-2004-pipesworld-no-tankage",
  "ipc-2004-pipesworld-tankage",
  "ipc-2004-promela-dining-philosophers",
  "ipc-2004-promela-optical-telegraph",
  "ipc-2004-satellite",
  "ipc-2004-settlers",
  "ipc-2006-pathways",
  "ipc-2006-pipesworld",
  "ipc-2006-rovers",
  "ipc-2006-storage",
  "ipc-2006-tpp",
  "ipc-2006-trucks",
  "ipc-2008-elevator",
  "ipc-2008-openstacks",
  "ipc-2008-parc-printer",
  "ipc-2008-peg-solitaire",
  "ipc-2008-scanalyzer-3d",
  "ipc-2008-sokoban",
  "ipc-2008-transport",
  "ipc-2008-woodworking",
  "ipc-2011-barman",
  "ipc-2011-elevator",
  "ipc-2011-floor-tile",
  "ipc-2011-no-mystery",
  "ipc-2011-openstacks",
  "ipc-2011-parc-printer",
  "ipc-2011-parking",
  "ipc-2011-peg-solitaire",
  "ipc-2011-scanalyzer-3d",
  "ipc-2011-sokoban",
  "ipc-2011-tidybot",
  "ipc-2011-transport",
  "ipc-2011-visit-all",
  "ipc-2011-woodworking",
  "ipc-2014-barman",
  "ipc-2014-cave-diving",
  "ipc-2014-child-snack",
  "ipc-2014-city-car",
  "ipc-2014-floor-tile",
  "ipc-2014-genome-edit-distances",
  "ipc-2014-hiking",
  "ipc-2014-maintenance",
  "ipc-2014-openstacks",
  "ipc-2014-parking",
  "ipc-2014-tetris",
  "ipc-2014-tidybot",
  "ipc-2014-transport",
  "ipc-2014-visit-all",
  "ipc-2018-agricola",
  "ipc-2018-caldera",
  "ipc-2018-data-network",
  "ipc-2018-nurikabe",
  "ipc-2018-organic-synthesis",
  "ipc-2018-petri-net-alignment",
  "ipc-2018-settlers",
  "ipc-2018-snake",
  "ipc-2018-spider",
  "ipc-2018-termes",
}

GENERAL_COST_DOMAINS = {
  "ipc-2008-elevator",
  "ipc-2008-openstacks",
  "ipc-2008-parc-printer",
  "ipc-2008-peg-solitaire",
  "ipc-2008-sokoban",
  "ipc-2008-transport",
  "ipc-2008-woodworking",
  "ipc-2011-barman",
  "ipc-2011-elevator",
  "ipc-2011-floor-tile",
  "ipc-2011-openstacks",
  "ipc-2011-parc-printer",
  "ipc-2011-peg-solitaire",
  "ipc-2011-scanalyzer-3d",
  "ipc-2011-sokoban",
  "ipc-2011-transport",
  "ipc-2011-woodworking",
  "ipc-2014-cave-diving",
  "ipc-2014-floor-tile",
  "ipc-2014-genome-edit-distances",
  "ipc-2014-openstacks",
  "ipc-2014-tetris",
  "ipc-2014-transport",
  "ipc-2018-agricola",
  "ipc-2018-data-network",
  "ipc-2018-petri-net-alignment",
  "ipc-2018-settlers",
  "ipc-2018-spider",
}

UNIT_COST_DOMAINS = {
  "ipc-1998-grid-2",
  "ipc-1998-gripper-1",
  "ipc-1998-logistics-1",
  "ipc-1998-logistics-2",
  "ipc-1998-movie-1",
  "ipc-1998-mystery-1",
  "ipc-1998-mystery-prime-1",
  "ipc-1998-mystery-prime-2",
  "ipc-2000-blocks",
  "ipc-2000-elevator-simple",
  "ipc-2000-freecell",
  "ipc-2000-logistics",
  "ipc-2002-depots",
  "ipc-2002-driverlog",
  "ipc-2002-freecell",
  "ipc-2002-rovers",
  "ipc-2002-satellite",
  "ipc-2002-zenotravel",
  "ipc-2004-airport",
  "ipc-2004-pipesworld-no-tankage",
  "ipc-2004-pipesworld-tankage",
  "ipc-2004-promela-dining-philosophers",
  "ipc-2004-promela-optical-telegraph",
  "ipc-2004-satellite",
  "ipc-2004-settlers",
  "ipc-2006-pathways",
  "ipc-2006-pipesworld",
  "ipc-2006-rovers",
  "ipc-2006-storage",
  "ipc-2006-tpp",
  "ipc-2006-trucks",
  "ipc-2008-scanalyzer-3d",
  "ipc-2011-no-mystery",
  "ipc-2011-parking",
  "ipc-2011-tidybot",
  "ipc-2011-visit-all",
  "ipc-2014-barman",
  "ipc-2014-child-snack",
  "ipc-2014-city-car",
  "ipc-2014-hiking",
  "ipc-2014-maintenance",
  "ipc-2014-parking",
  "ipc-2014-tidybot",
  "ipc-2014-visit-all",
  "ipc-2018-caldera",
  "ipc-2018-nurikabe",
  "ipc-2018-organic-synthesis",
  "ipc-2018-snake",
  "ipc-2018-termes",
}

GROUNDED_DOMAINS = {
  "ipc-2004-airport",
  "ipc-2004-promela-optical-telegraph",
  "ipc-2004-promela-dining-philosophers",
  "ipc-2006-tpp",
  "ipc-2006-rovers",
  "ipc-2006-pathways",
  "ipc-2006-pipesworld",
  "ipc-2006-trucks",
  "ipc-2008-parc-printer",
  "ipc-2008-openstacks",
  "ipc-2011-openstacks",
  "ipc-2014-openstacks",
  "ipc-2018-petri-net-alignment",
}

UNIT_COST_DOMAIN_TO_IPC = {
  'organicsynthesis': {'ipc-2018'},
  'rovers': {'ipc-2006', 'ipc-2002'},
  'snake': {'ipc-2018'},
  'caldera': {'ipc-2018'},
  'tidybot': {'ipc-2011', 'ipc-2014'},
  'pathways': {'ipc-2006'},
  'mystery': {'ipc-1998'},
  'gripper': {'ipc-1998'},
  'childsnack': {'ipc-2014'},
  'promeladiningphilosophers': {'ipc-2004'},
  'satellite': {'ipc-2002', 'ipc-2004'},
  'parking': {'ipc-2011', 'ipc-2014'},
  'freecell': {'ipc-2000', 'ipc-2002'},
  'zenotravel': {'ipc-2002'},
  'elevatorsimple': {'ipc-2000'},
  'movie': {'ipc-1998'},
  'logistics': {'ipc-2000', 'ipc-1998'},
  'settlers': {'ipc-2004'},
  'maintenance': {'ipc-2014'},
  'visitall': {'ipc-2011', 'ipc-2014'},
  'mysteryprime': {'ipc-1998'},
  'termes': {'ipc-2018'},
  'airport': {'ipc-2004'},
  'hiking': {'ipc-2014'},
  'promelaopticaltelegraph': {'ipc-2004'},
  'pipesworldtankage': {'ipc-2004'},
  'pipesworld': {'ipc-2006'},
  'storage': {'ipc-2006'},
  'trucks': {'ipc-2006'},
  'blocks': {'ipc-2000'},
  'barman': {'ipc-2014'},
  'pipesworldnotankage': {'ipc-2004'},
  'driverlog': {'ipc-2002'},
  'depots': {'ipc-2002'},
  'grid': {'ipc-1998'},
  'tpp': {'ipc-2006'},
  'citycar': {'ipc-2014'},
  'nurikabe': {'ipc-2018'},
  'scanalyzerd': {'ipc-2008'},
  'nomystery': {'ipc-2011'},
  }

IPC_UNIQUE_DOMAINS = {
"agricola",
"airport",
"barman",
"blocks",
"caldera",
"cavediving",
"childsnack",
"citycar",
"datanetwork",
"depots",
"driverlog",
"elevator",
"floortile",
"freecell",
"genomeeditdistances",
"grid",
"gripper",
"hiking",
"logistics",
"maintenance",
"movie",
"mystery",
"nurikabe",
"openstacks",
"organicsynthesis",
"parcprinter",
"parking",
"pathways",
"pegsolitaire",
"petrinetalignment",
"pipesworld",
"promeladiningphilosophers",
"promelaopticaltelegraph",
"rovers",
"satellite",
"scanalyzerd",
"settlers",
"snake",
"sokoban",
"spider",
"storage",
"termes",
"tetris",
"tidybot",
"tpp",
"transport",
"trucks",
"visitall",
"woodworking",
"zenotravel",
}


def simplify_domain_name(domain):
  domain = domain.replace("-", "").replace("ipc", "").replace("htg", "")
  domain = ''.join([i for i in domain if not i.isdigit()])
  return domain


def same_domain(str1, str2):
  str1 = simplify_domain_name(str1)
  str2 = simplify_domain_name(str2)
  return str1 in str2 or str2 in str1


def get_simplified_ipc_domain_name(domain):
  domain = simplify_domain_name(domain)
  for d in IPC_UNIQUE_DOMAINS:
    if same_domain(d, domain):
      return d
  raise ValueError

# def unique_domains():
#   ret = set()
#   for domain in IPC_DOMAINS:
#     d1 = simplify_domain_name(domain)
#     good = True
#     for d2 in ret:
#       if same_domain(d1, d2):
#         good = False
#         # if len(d1) < len(d2):
#         #   ret.remove(d2)
#         #   ret.add(d1)
#         break
#     if good:
#       ret.add(d1)
#   return sorted(ret)
#
# for d in unique_domains():
#   print("\""+d+"\",")

def get_ipc_domain_problem_files(del_free: bool=False):
  """ Generate train data from IPC benchmarks which can be downloaded from the repository
    https://github.com/potassco/pddl-instances

    Note we did some additional handcrafted pruning of which domains we care about by removing
    adl, temporal, multi-core, probabilistic etc.
"""
  suffix = "" if not del_free else "_del_free"
  ret = []
  import os
  import re
  for ipc in IPCS:
    dir_path = f'../dataset/ipc/{ipc}/domains'
    for domain_name in os.listdir(dir_path):
      if 'README' in domain_name:
        continue

      domain_pddl = f'{dir_path}/{domain_name}/domain{suffix}.pddl'
      problem_path = f'{dir_path}/{domain_name}/instances'
      problem_pddls = []
      for p_file in os.listdir(problem_path):
        if "mod" in p_file and int(re.findall(r'\d+', p_file)[-1]) >= 0:
          continue
        if not del_free and "df" in p_file:
          continue
        if del_free and "opt" in p_file:
          continue
        problem_pddls.append(f'{problem_path}/{p_file}')
      if os.path.exists(domain_pddl):
        for problem_pddl in problem_pddls:
          ret.append((
            f'{ipc}-{domain_name}',
            domain_pddl,
            problem_pddl
          ))
      else:
        # print(f'{ipc}-{domain_name}')
        # os.system(f"code {dir_path}/{domain_name}/domains/domain-1.pddl")
        for problem_pddl in problem_pddls:
          num = re.findall(r'\d+', os.path.basename(problem_pddl))[0]
          domain_pddl = f'{dir_path}/{domain_name}/domains/domain-{num}{suffix}.pddl'
          assert os.path.exists(domain_pddl)
          assert os.path.exists(problem_pddl)
          ret.append((
            f'{ipc}-{domain_name}',
            domain_pddl,
            problem_pddl
          ))
  return ret
# get_ipc_domain_problem_files(False)
